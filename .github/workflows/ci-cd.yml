name: rushWash í•™ê³¼ ì„œë²„ ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ "main", "deploy-dev" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: fronted ë””ë ‰í† ë¦¬ ì•ˆ íŒŒì¼ ì§€ìš°ê¸°
        run: |
          rm -rf back/rushWash/src/main/frontend/* \
                 back/rushWash/src/main/frontend/.[!.]* \
                 back/rushWash/src/main/frontend/..?* || true

      - name: frontend ë¡œ front íŒŒì¼ ë³µì‚¬
        run: |
          mkdir -p back/rushWash/src/main/frontend
          cp -r front/fe-rw/* back/rushWash/src/main/frontend/

#      - name: frontend ë¡œ front íŒŒì¼ ë³µì‚¬ (ë³€ê²½ëœ íŒŒì¼ë§Œ)
#        run: |
#          rsync -a --delete front/fe-rw/ back/rushWash/src/main/frontend/
#
#      - name: Grant permission to Gradle
#        run: chmod +x back/rushWash/gradlew
#        working-directory: .
#        env:
#          CI: false

      - name: Grant permission to Gradle
        run: chmod +x back/rushWash/gradlew
        working-directory: .
        env:
          CI: false

      - name: application.yml íŒŒì¼ ì„¤ì •
        run: |
          mkdir -p back/rushWash/src/main/resources
          printf "%s" "${{ secrets.APPLICATION_YML }}" > back/rushWash/src/main/resources/application.yml

      - name: Build jar
        run: ./gradlew build -x test
        working-directory: back/rushWash

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      #      - name: ê¸°ì¡´ ai í´ë” ì‚­ì œ
      #        run: ssh -o StrictHostKeyChecking=no -p 22 t25119@ceprj.gachon.ac.kr "rm -rf /home/t25119/v109.src/ai"

      - name: ë°°í¬ back ë””ë ‰í† ë¦¬ ë§Œë“¤ê¸°
        run: ssh -o StrictHostKeyChecking=no -p 22 t25119@ceprj.gachon.ac.kr "mkdir -p /home/t25119/v109.src/back"

      - name: jar í•™ê³¼ ì„œë²„ë¡œ ë³µì‚¬
        run: scp -o StrictHostKeyChecking=no -P 22 back/rushWash/build/libs/rushWash-0.0.1-SNAPSHOT.jar t25119@ceprj.gachon.ac.kr:/home/t25119/v109.src/back

      - name: ai í´ë” ë™ê¸°í™” (ë³€ê²½ëœ íŒŒì¼ë§Œ)
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p 22" \
            ai/ t25119@ceprj.gachon.ac.kr:/home/t25119/v109.src/ai/

      #      - name: ai í´ë” ë³µì‚¬
      #        run: scp -o StrictHostKeyChecking=no -r -P 22 ai t25119@ceprj.gachon.ac.kr:/home/t25119/v109.src/

      - name: ì„œë²„ ì‹¤í–‰
        run: |
          ssh -o StrictHostKeyChecking=no -p 22 t25119@ceprj.gachon.ac.kr "
            if [ -f /home/t25119/v109.src/app.pid ]; then
              kill \$(cat /home/t25119/v109.src/app.pid) || true
            fi
          
            # ðŸ”¹ test.py ì‹¤í–‰ (ì„œë²„ ì‹¤í–‰ ì „ì—)
            cd /home/t25119/v109.src/ai && python3 test.py
          
            # ðŸ”¹ ë°±ì—”ë“œ ì‹¤í–‰
            nohup java -jar /home/t25119/v109.src/back/rushWash-0.0.1-SNAPSHOT.jar > /home/t25119/v109.src/app.log 2>&1 &
            echo \$! > /home/t25119/v109.src/app.pid
          "
